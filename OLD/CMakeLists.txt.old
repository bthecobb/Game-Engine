cmake_minimum_required(VERSION 3.20)
project(AAA_Game_Engine LANGUAGES CXX)

# Enable CUDA if available
option(ENABLE_CUDA "Enable CUDA features" ON)
if(ENABLE_CUDA)
    set(CMAKE_CUDA_ARCHITECTURES 86)
    enable_language(CUDA)
    find_package(CUDAToolkit REQUIRED)
endif()

# Standard settings
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# MSVC settings
if(CMAKE_CXX_COMPILER_ID MATCHES "MSVC")
    message(STATUS "Configuring for MSVC compiler")
    set(CMAKE_CXX_FLAGS_DEBUG "/MDd /Zi /Od /RTC1")
    set(CMAKE_CXX_FLAGS_RELEASE "/MD /O2")
    add_compile_definitions(
        _CRT_SECURE_NO_WARNINGS
    )
endif()

# Windows settings
if(WIN32)
    add_definitions(-DNOMINMAX)
endif()

# Asset directory
set(ASSET_DIR "${CMAKE_SOURCE_DIR}/assets" CACHE PATH "Path to your assets root")

# Required packages
find_package(OpenGL REQUIRED)

# GLFW
find_package(glfw3 QUIET)
if(NOT glfw3_FOUND)
    include(FetchContent)
    FetchContent_Declare(
        glfw
        GIT_REPOSITORY https://github.com/glfw/glfw.git
        GIT_TAG 3.3.8
    )
    FetchContent_MakeAvailable(glfw)
endif()

# GLAD
find_package(glad QUIET)
if(NOT glad_FOUND)
    include(FetchContent)
    FetchContent_Declare(
        glad
        GIT_REPOSITORY https://github.com/Dav1dde/glad.git
        GIT_TAG v0.1.36
    )
    FetchContent_MakeAvailable(glad)
endif()

# GLM Setup
set(GLM_DIR "${CMAKE_SOURCE_DIR}/external/glm")
add_library(glm_interface INTERFACE)
target_include_directories(glm_interface INTERFACE ${GLM_DIR})
add_library(glm::glm ALIAS glm_interface)

# Configure Assimp
find_package(assimp QUIET)
if(NOT assimp_FOUND)
    include(FetchContent)
    FetchContent_Declare(
        assimp
        GIT_REPOSITORY https://github.com/assimp/assimp.git
        GIT_TAG v5.2.5
        CMAKE_ARGS
            -DASSIMP_BUILD_TESTS=OFF
            -DASSIMP_WARNINGS_AS_ERRORS=OFF
            -DBUILD_SHARED_LIBS=OFF
            -DASSIMP_BUILD_STATIC_LIB=ON
            -DASSIMP_NO_EXPORT=ON
            -DASSIMP_BUILD_ZLIB=ON
            -DCMAKE_POSITION_INDEPENDENT_CODE=ON
    )
    FetchContent_MakeAvailable(assimp)
    set(ASSIMP_INCLUDE_DIR ${assimp_SOURCE_DIR}/include)
    set(ASSIMP_LIBRARY ${assimp_BINARY_DIR}/lib/assimp.lib)
endif()

# Include directories
include_directories(
    ${CMAKE_SOURCE_DIR}/include_refactored
    ${ASSIMP_INCLUDE_DIR}
    ${CMAKE_SOURCE_DIR}/vendor/PhysX/physx/include
)
# Configure warnings for targets
function(configure_target_warnings TARGET_NAME)
if(MSVC)
        target_compile_options(${TARGET_NAME} PRIVATE /W4 /wd4100)
    else()
        target_compile_options(${TARGET_NAME} PRIVATE -Wall -Wextra)
        if(NOT ${TARGET_NAME} MATCHES "^.*Test.*$")
            target_compile_options(${TARGET_NAME} PRIVATE -Werror)
        endif()
    endif()
endfunction()

# Full3DGame target
add_executable(Full3DGame
    src_refactored/EnhancedGameMain_Full3D.cpp
    src_refactored/Gameplay/PlayerMovementSystem.cpp
    src_refactored/Gameplay/CharacterControllerSystem.cpp
    src_refactored/Gameplay/EnemyAISystem.cpp
    src_refactored/Gameplay/LevelSystem.cpp
    src_refactored/Gameplay/TargetingSystem.cpp
    src_refactored/Core/EntityManager.cpp
    src_refactored/Core/ComponentManager.cpp
    src_refactored/Physics/PhysicsSystem.cpp
    src_refactored/Physics/CudaPhysicsSystem.cpp
    src_refactored/Physics/CollisionDetection.cpp
    src_refactored/Physics/WallRunningSystem.cpp
    src_refactored/Rendering/RenderSystem.cpp
    src_refactored/Rendering/CameraDebugSystem.cpp
    src_refactored/Rendering/ShaderProgram.cpp
    src_refactored/Rendering/Camera.cpp
    src_refactored/Rendering/OrbitCamera.cpp
    src_refactored/Rendering/Framebuffer.cpp
    src_refactored/Rendering/LightingSystem.cpp
    src_refactored/Rendering/Mesh.cpp
    src_refactored/Debug/OpenGLDebugRenderer.cpp
    src_refactored/Rendering/RenderDebugSystem.cpp
    src_refactored/Particles/ParticleSystem.cpp
    src_refactored/Animation/AnimationSystem.cpp
)

target_include_directories(Full3DGame PRIVATE
    ${CMAKE_SOURCE_DIR}/include_refactored
    ${ASSIMP_INCLUDE_DIR}
    ${assimp_BINARY_DIR}/include
)

# Enable GLM experimental features
# GLM macros are now defined in Core/GLMConfig.h instead

configure_target_warnings(Full3DGame)

target_link_libraries(Full3DGame PRIVATE
    ${OPENGL_LIBRARIES}
    glfw
    glad
    glm::glm
    assimp
)

if(ENABLE_CUDA)
    target_link_libraries(Full3DGame PRIVATE CUDA::cudart)
    target_compile_definitions(Full3DGame PRIVATE ENABLE_CUDA)
endif()

target_compile_definitions(Full3DGame PRIVATE ASSET_DIR="${ASSET_DIR}")

# Enable verbose output for debugging
set(CMAKE_VERBOSE_MAKEFILE ON)