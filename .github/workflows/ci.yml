name: CudaGame CI

# Advanced CI workflow for AAA game development
run-name: CI Build for ${{ github.ref_name }}

on:
  push:
    branches: [main, develop, 'feature/**', 'bugfix/**']
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 2 * * *' # Nightly builds

env:
  BUILD_TYPE: Release
  CMAKE_VERSION: '3.20'
  CUDA_VERSION: '11.8'
  PHYSX_VERSION: '5.1'
  CPP_STANDARD: '17'

jobs:
  cpp-build-and-test:
    name: Build & Test C++ (${{ matrix.os }}, ${{ matrix.build_type }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-22.04]
        build_type: [Release, RelWithDebInfo]
        include:
          - os: windows-latest
            cmake_generator: 'Visual Studio 17 2022'
          - os: ubuntu-22.04
            cmake_generator: 'Ninja'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: 'recursive'

      - name: Cache Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/vcpkg
            ${{github.workspace}}/build/_deps
          key: ${{runner.os}}-deps-${{hashFiles('**/CMakeLists.txt')}}

      - name: Setup CMake
        uses: lukka/get-cmake@latest
        with:
          cmake-version: ${{env.CMAKE_VERSION}}

      - name: Setup CUDA
        uses: Jimver/cuda-toolkit@v0.2.11
        with:
          cuda: ${{env.CUDA_VERSION}}
          method: 'network'
          sub-packages: '["nvcc", "visual_studio_integration", "cudart", "cublas", "cusolver", "cusparse"]'

      - name: Install Dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build
          sudo apt-get install -y libvulkan-dev
          sudo apt-get install -y libglfw3-dev
          
      - name: Create Build Directory
        run: |
          if ('${{ runner.os }}' -eq 'Windows') {
            New-Item -ItemType Directory -Force -Path ${{github.workspace}}/build
          } else {
            mkdir -p ${{github.workspace}}/build
          }

      - name: Configure CMake
        shell: bash
        run: |
          
          cmake -B ${{github.workspace}}/build -S ${{github.workspace}} \
            -G "${{ matrix.cmake_generator }}" \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DCMAKE_CXX_STANDARD=${{env.CPP_STANDARD}} \
            -DBUILD_TESTING=ON \
            -DENABLE_CUDA=ON \
            -DENABLE_PHYSX=ON \
            -DCMAKE_CUDA_ARCHITECTURES=75 \
            -DCMAKE_CUDA_COMPILER=$(which nvcc) \
            -DPHYSX_ROOT=${PHYSX_SDK_PATH:-$env:PHYSX_SDK_PATH}

      - name: Build
        run: cmake --build ${{github.workspace}}/build --config ${{env.BUILD_TYPE}} --parallel

      - name: Run Core Tests
        working-directory: ${{github.workspace}}/build
        run: ctest -C ${{env.BUILD_TYPE}} --output-on-failure --label-regex "Core"
        
      - name: Run Rendering Tests
        working-directory: ${{github.workspace}}/build
        run: ctest -C ${{env.BUILD_TYPE}} --output-on-failure --label-regex "Rendering"

      - name: Run Performance Tests
        working-directory: ${{github.workspace}}/build
        run: ctest -C ${{env.BUILD_TYPE}} --output-on-failure --label-regex "Performance"
        
      - name: Package Build Artifacts
        run: |
          7z a -tzip cuda_game_artifacts.zip `
            ${{github.workspace}}/build/*.exe `
            ${{github.workspace}}/build/*.dll `
            ${{github.workspace}}/build/*.pdb

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cuda-game-build
          path: cuda_game_artifacts.zip
          retention-days: 5

  java-integration-tests:
    name: Integration Tests
    needs: cpp-build-and-test
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: ${{github.repository_owner}}/CudaGame-CI
          token: ${{secrets.INTEGRATION_PAT}}
          fetch-depth: 0

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '11'
          cache: 'maven'

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: cuda-game-build
          path: game-build

      - name: Extract Game Build
        run: 7z x game-build/cuda_game_artifacts.zip -ogame-build

      - name: Run Integration Tests
        run: mvn verify -P integration-tests
        env:
          GAME_BUILD_PATH: ${{github.workspace}}/game-build

      - name: Generate Allure Report
        if: always()
        run: mvn allure:report

      - name: Upload Test Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: target/site/allure-report

  quality-analysis:
    name: Code Quality Analysis
    needs: cpp-build-and-test
    runs-on: windows-latest
    env:
      BUILD_WRAPPER_OUT_DIR: build_wrapper_output
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~\sonar\cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Install sonar-scanner and build-wrapper
        uses: SonarSource/sonarcloud-github-c-cpp@v2

      - name: Setup CUDA
        uses: Jimver/cuda-toolkit@v0.2.11
        with:
          cuda: ${{env.CUDA_VERSION}}
          method: 'network'
          sub-packages: '["nvcc", "visual_studio_integration", "cudart", "cublas", "cusolver", "cusparse"]'

      - name: Run build-wrapper
        run: |
          New-Item -ItemType Directory -Force -Path ${{env.BUILD_WRAPPER_OUT_DIR}}
          build-wrapper-win-x86-64 --out-dir ${{env.BUILD_WRAPPER_OUT_DIR}} `
            cmake --build ${{github.workspace}}/build --config Release

      # Run static analyzers
      - name: Run Clang-Tidy
        run: |
          cmake -B ${{github.workspace}}/analysis -S ${{github.workspace}} `
            -DENABLE_CLANG_TIDY=ON `
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
          python scripts/run-clang-tidy.py `
            -p ${{github.workspace}}/analysis `
            -header-filter='.*' `
            -checks='-*,clang-analyzer-*,performance-*,readability-*,modernize-*,bugprone-*,cert-*' `
            > clang-tidy-report.txt

      - name: Run Cppcheck
        run: |
          cppcheck --enable=all --inconclusive --xml --xml-version=2 `
            -I include -I src `
            --suppress=missingIncludeSystem `
            --suppress=unmatchedSuppression `
            --output-file=cppcheck-report.xml `
            src

      # CUDA-specific analysis
      - name: Run CUDA Memory Checker
        run: |
          New-Item -ItemType Directory -Force -Path cuda_analysis
          ForEach ($file in Get-ChildItem -Path src -Filter *.cu -Recurse) {
            ${{env.CUDA_PATH}}/bin/cuda-memcheck `
              --tool memcheck `
              --leak-check full `
              --track-origins yes `
              $file.FullName `
              > cuda_analysis/$($file.BaseName)_memcheck.txt
          }

      - name: Run Compute Sanitizer
        run: |
          ForEach ($file in Get-ChildItem -Path src -Filter *.cu -Recurse) {
            ${{env.CUDA_PATH}}/bin/compute-sanitizer `
              --tool initcheck `
              $file.FullName `
              > cuda_analysis/$($file.BaseName)_sanitizer.txt
          }

      # Generate test coverage
      - name: Generate Coverage Report
        run: |
          OpenCppCoverage.exe `
            --sources src `
            --excluded_sources external `
            --export_type cobertura:coverage.xml `
            -- ${{github.workspace}}/build/tests/UnitTests.exe

      # Run SonarCloud analysis
      - name: SonarCloud Analysis
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Default GitHub token
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}  # Using SonarCloud token for analysis
        run: |
          sonar-scanner.bat `
            -D"sonar.cfamily.build-wrapper-output=${{env.BUILD_WRAPPER_OUT_DIR}}" `
            -D"sonar.coverageReportPaths=coverage.xml" `
            -D"sonar.cpp.cppcheck.reportPaths=cppcheck-report.xml" `
            -D"sonar.cpp.clangsa.reportPaths=clang-tidy-report.txt" `
            -D"sonar.cfamily.threads=4" `
            -D"sonar.cfamily.cache.enabled=true" `
            -D"sonar.cfamily.cache.path=sonar-cache"

      # Upload analysis artifacts
      - name: Upload Analysis Reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: code-analysis-reports
          path: |
            clang-tidy-report.txt
            cppcheck-report.xml
            coverage.xml
            cuda_analysis/
            ${{env.BUILD_WRAPPER_OUT_DIR}}/

  deployment:
    name: Deploy Build
    needs: [cpp-build-and-test, java-integration-tests, quality-analysis]
    if: github.ref == 'refs/heads/main'
    runs-on: windows-latest
    steps:
      - name: Download Build
        uses: actions/download-artifact@v4
        with:
          name: cuda-game-build

      - name: Setup Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: cuda_game_artifacts.zip
          generate_release_notes: true