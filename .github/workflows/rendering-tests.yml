name: CUDA Rendering Tests

on:
  push:
    paths:
      - 'src/rendering/**'
      - 'src/shaders/**'
      - 'tests/rendering/**'
      - 'CMakeLists.txt'
  pull_request:
    paths:
      - 'src/rendering/**'
      - 'src/shaders/**'
      - 'tests/rendering/**'
      - 'CMakeLists.txt'

env:
  BUILD_TYPE: Release
  CUDA_VERSION: '11.8.0'
  VULKAN_SDK_VERSION: '1.3.250.1'

jobs:
  cuda-tests:
    name: CUDA Rendering Tests
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-22.04]
        include:
          - os: windows-latest
            cmake_generator: 'Visual Studio 17 2022'
          - os: ubuntu-22.04
            cmake_generator: 'Ninja'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update submodules
        run: |
          git submodule deinit -f --all
          git submodule update --init --recursive

      - name: Setup GLM
        shell: bash
        run: |
          rm -rf external/glm || true
          mkdir -p external/glm
          git clone --depth 1 https://github.com/g-truc/glm.git external/glm

      - name: Setup CUDA
        uses: Jimver/cuda-toolkit@v0.2.11
        with:
          cuda: ${{env.CUDA_VERSION}}
          method: 'network'
          sub-packages: '["nvcc", "visual_studio_integration", "cudart", "cublas", "cusolver", "cusparse", "curand"]'

      - name: Install Vulkan SDK
        uses: humbletim/setup-vulkan-sdk@v1.2.0
        with:
          vulkan-query-version: ${{env.VULKAN_SDK_VERSION}}
          vulkan-components: Vulkan-Headers, Vulkan-Loader
          vulkan-use-cache: false

      - name: Cache Vulkan SDK
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.VULKAN_SDK }}
            ~/.vulkan
          key: vulkan-${{ runner.os }}-${{ env.VULKAN_SDK_VERSION }}
          restore-keys: |
            vulkan-${{ runner.os }}-

      - name: Setup Dependencies
        shell: pwsh
        run: |
          if (-not (Test-Path "external/glm/glm/glm.hpp")) {
            New-Item -ItemType Directory -Force -Path external/glm
            git clone --depth 1 https://github.com/g-truc/glm.git external/glm
          }

      - name: Install Dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build
          sudo apt-get install -y libvulkan-dev
          sudo apt-get install -y libglfw3-dev
          
      - name: Configure Rendering Tests
        shell: bash
        run: |
          # Create build directory if it doesn't exist
          New-Item -ItemType Directory -Force -Path ${{github.workspace}}/build
          
          cmake -B ${{github.workspace}}/build -S ${{github.workspace}} `
            -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} `
            -DBUILD_RENDERING_TESTS=ON `
            -DENABLE_CUDA=ON `
            -DENABLE_VULKAN=ON `
            -DCMAKE_CUDA_ARCHITECTURES=75 `
            -DCMAKE_CUDA_COMPILER=$(which nvcc) `
            -DVULKAN_SDK=$env:VULKAN_SDK

      - name: Build Tests
        run: |
          cmake --build ${{github.workspace}}/build `
            --config ${{env.BUILD_TYPE}} `
            --target RenderingTests `
            --parallel

      - name: Run CUDA Tests
        working-directory: ${{github.workspace}}/build
        run: |
          ${{env.CUDA_PATH}}/bin/cuda-memcheck `
            ./tests/RenderingTests/RenderingTests.exe `
            --gtest_filter=*CUDA*

      - name: Run Performance Tests
        if: success()
        working-directory: ${{github.workspace}}/build
        run: |
          ./tests/RenderingTests/RenderingTests.exe `
            --gtest_filter=*Performance*

      - name: Generate Performance Report
        if: always()
        run: |
          python scripts/analyze_perf.py `
            --input ${{github.workspace}}/build/perf_results.json `
            --output perf_report.md

      - name: Upload Performance Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-report
          path: perf_report.md
          retention-days: 5
